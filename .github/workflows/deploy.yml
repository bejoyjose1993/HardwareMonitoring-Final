name: CI/CD Pipeline - Azure

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    # Step 1 — Log in to Azure Container Registry (ACR)
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.AZURE_REGISTRY_USERNAME }}
        password: ${{ secrets.AZURE_REGISTRY_PASSWORD }}

    # Step 2 — Build and Push backend 
    - name: Build and push edgemonitor-backend image
      run: |
        docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_backend:latest ./edgemonitor-backend
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_backend:latest

    # Step 3 — Build and Push gateway
    - name: Build and push edgemonitor_gateway image
      run: |
        docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_gateway:latest ./edgemonitor-gateway
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_gateway:latest

    # Step 4 — Build and Push notification service
    - name: Build and push edgemonitor_notification service image
      run: |
        docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_notification:latest ./edgemonitor-notification
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_notification:latest

    # Step 5 — Build and Push Edge Monitor (Python)
    - name: Build and push edge_monitor service image
      run: |
        docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edge_monitor:latest ./edge_monitor
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edge_monitor:latest

    # Step 6 — Build and Push frontend (Angular)
    - name: Build and push edge_monitor_dashboard image
      run: |
        docker build \
          --build-arg BASE_API_URL=${{ secrets.BASE_API_URL }} \
          --build-arg FAST_BASE_API_URL=${{ secrets.FAST_BASE_API_URL }} \
          -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_dashboard:latest ./edge_monitor_dashboard
        docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/edgemonitor_dashboard:latest

    # Step 7 — Deploy to Azure VM (via SSH)
    - name: Deploy to Azure VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AZURE_VM_HOST }}
        username: azureuser
        key: ${{ secrets.AZURE_VM_SSH_KEY }}
        script: |
          sudo az acr login --name ${{ secrets.AZURE_REGISTRY_NAME }}
          cd ~/HardwareMonitoring-Final
          docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production pull
          docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production down
          docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production up -d
          docker image prune -a -f
